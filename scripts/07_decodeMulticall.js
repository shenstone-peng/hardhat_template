const { providers } = require("ethers");
const {network, ethers} = require("hardhat");
const hre = require("hardhat");


const axios = require("axios");
//const CALLDATA = "0x000000000000000000000000000000000000000000000000000000006226273200000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000e404e45aaf000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb4800000000000000000000000000000000000000000000000000000000000001f4000000000000000000000000f871b9be3962fea0a62f847a2361315f6e551255000000000000000000000000000000000000000000000000002386f26fc1000000000000000000000000000000000000000000000000000000000000013f38a5000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";
//
//const CALLDATA="0x0000000000000000000000000000000000000000000000000000000061c99a5700000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000e4472b43f3000000000000000000000000000000000000000000000000000009184e72a000000000000000000000000000000000000000000000004850df617e6991d316f50000000000000000000000000000000000000000000000000000000000000080000000000000000000000000931bf252a4535538a847f5766db4b11bb90ffd720000000000000000000000000000000000000000000000000000000000000002000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000006adb2e268de2aa1abf6578e4a8119b960e02928f00000000000000000000000000000000000000000000000000000000";

const CALLDATA="0x0000000000000000000000000000000000000000000000000000000061c99a5700000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000e4472b43f3000000000000000000000000000000000000000000000000000009184e72a000000000000000000000000000000000000000000000004850df617e6991d316f50000000000000000000000000000000000000000000000000000000000000080000000000000000000000000931bf252a4535538a847f5766db4b11bb90ffd720000000000000000000000000000000000000000000000000000000000000002000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000006adb2e268de2aa1abf6578e4a8119b960e02928f00000000000000000000000000000000000000000000000000000000"
function extractParameters(signature) {
    let params = [];

    const allParameters = /\b[^()]+\((.*)\)$/gm;

    let _allParameters = allParameters.exec(signature)[1];
    let test =_allParameters.replace("(","")
    test = test.replace(")","")
    
    params = test.split(",")
    return params;
}
async function decode(calldata) {
    let m_abiCoder = ethers.utils.defaultAbiCoder ;
    let deadline = m_abiCoder.decode(['uint256', 'bytes[]'], calldata)[0];
    console.log("deadline: %s", deadline);
    let calls = m_abiCoder.decode(['uint256', 'bytes[]'], calldata)[1];
    console.log(calls)
    console.log("bytes.length: %d",calls.length);
    for (let index = 0; index < calls.length; index++) {
        let call = calls[index].replace("0x", "");
        
        let selector = call.slice(0, 8);
        
        let data = call.slice(8);
        console.log("Index:[%d] \nFunction Selector:%s \nData:%s ", index, selector, data);
        let request = await axios.get(
            `https://www.4byte.directory/api/v1/signatures/?hex_signature=${selector}`
        );
        let signature = request.data.results[0].text_signature;
        data ="0x"+data
        console.log()
        console.log(`步骤 ${index}, 方法: ${signature}`);
        let parameters = extractParameters(signature);
        
        let ss = m_abiCoder.decode(parameters,data)
        for(let i=0;i<ss.length;i++){
            console.log(`parameters: ${parameters[i]}      value: ${ss[i]}`)
        }
    }
}

decode(CALLDATA);
//let parameters=extractParameters("exactInputSingle((address,address,uint24,address,uint256,uint256,uint160))")
//console.log(parameters)